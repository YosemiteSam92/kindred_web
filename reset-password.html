<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset - Token Exchange Test</title>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Token Exchange Test</h1>
    <p>Check the console for debug output...</p>
    <div id="status">Initializing...</div>

    <script>
        // Initialize Supabase client
        // TODO: Replace these with your actual Supabase project credentials
        const SUPABASE_URL = 'https://heppdnfdklfpckxzopzd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcHBkbmZka2xmcGNreHpvcHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTc0NDEsImV4cCI6MjA2Njc5MzQ0MX0.j5qZzIlVvn5evXNvomUb6qXWUm26vcGfDu8r7iNhx28';
        
        console.log('Initializing Supabase client...');
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Function to parse URL hash parameters
        function getHashParams() {
            const hash = window.location.hash.substring(1); // Remove the #
            const params = new URLSearchParams(hash);
            
            const access_token = params.get('access_token');
            const type = params.get('type');
            
            console.log('Parsed hash parameters:', {
                access_token: access_token ? `${access_token.substring(0, 10)}...` : 'not found',
                type: type
            });
            
            return { access_token, type };
        }
        
        // Function to exchange token for session
        async function exchangeTokenForSession() {
            const statusEl = document.getElementById('status');
            
            try {
                // Step 1: Extract token from URL
                console.log('Step 1: Extracting token from URL...');
                const { access_token, type } = getHashParams();
                
                if (!access_token) {
                    throw new Error('No access token found in URL');
                }
                
                if (type !== 'recovery') {
                    console.warn(`Expected type 'recovery', got '${type}'`);
                }
                
                // Step 2: Exchange token for session
                console.log('Step 2: Exchanging token for session...');
                statusEl.textContent = 'Exchanging token...';
                
                const { data, error } = await supabase.auth.verifyOtp({
                    token_hash: access_token,
                    type: 'recovery'
                });
                
                if (error) {
                    throw error;
                }
                
                console.log('Token exchange successful!');
                console.log('Session data:', data);
                
                // Check if we have a valid session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    throw sessionError;
                }
                
                if (session) {
                    console.log('Valid session established!');
                    console.log('User ID:', session.user.id);
                    console.log('User email:', session.user.email);
                    statusEl.textContent = `Success! Session established for ${session.user.email}`;
                } else {
                    throw new Error('No session returned after token exchange');
                }
                
            } catch (error) {
                console.error('Error during token exchange:', error);
                statusEl.textContent = `Error: ${error.message}`;
            }
        }
        
        // Run the exchange when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, starting token exchange process...');
            console.log('Current URL:', window.location.href);
            exchangeTokenForSession();
        });
    </script>
</body>
</html>
