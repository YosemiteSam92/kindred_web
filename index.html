<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindred - Reset Password</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        h1 { color: #6a1b9a; }
        p { color: #555; }
        input { width: calc(100% - 20px); padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background-color: #6a1b9a; color: white; border: none; padding: 14px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background-color: #999; }
        .loader { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #6a1b9a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { margin-top: 20px; padding: 12px; border-radius: 8px; display: none; }
        .message.success { background-color: #e8f5e9; color: #2e7d32; }
        .message.error { background-color: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Set a New Password</h1>
        <p>Please enter and confirm your new password for your Kindred account.</p>
        
        <input type="password" id="newPassword" placeholder="New Password" required>
        <input type="password" id="confirmPassword" placeholder="Confirm New Password" required>

        <button id="savePasswordBtn">Update Password</button>
        <div class="loader" id="loadingIndicator"></div>

        <div id="messageDisplay" class="message"></div>
    </div>

    <script>
    const SUPABASE_URL = 'https://heppdnfdklfpckxzopzd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcHBkbmZka2xmcGNreHpvcHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTc0NDEsImV4cCI6MjA2Njc5MzQ0MX0.j5qZzIlVvn5evXNvomUb6qXWUm26vcGfDu8r7iNhx28';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get references to all HTML elements
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const savePasswordBtn = document.getElementById('savePasswordBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const messageDisplay = document.getElementById('messageDisplay');

    let hasPasswordRecoveryToken = false;

    // Function to display messages to the user
    function showMessage(text, isError = false) {
        messageDisplay.innerHTML = text; // Use innerHTML to allow for links
        messageDisplay.className = 'message ' + (isError ? 'error' : 'success');
        messageDisplay.style.display = 'block';
    }

    // --- Main Logic: Listen for PASSWORD_RECOVERY event ---
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        if (event === 'PASSWORD_RECOVERY') {
            hasPasswordRecoveryToken = true;
            savePasswordBtn.disabled = false;
        }
    });

    // Function to handle the password reset logic
    async function handleResetPassword() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // --- Basic Validation ---
        if (!newPassword || !confirmPassword) {
            showMessage('Please fill in both password fields.', true);
            return;
        }
        if (newPassword !== confirmPassword) {
            showMessage('Passwords do not match.', true);
            return;
        }
        if (newPassword.length < 6) { // Corresponds to Supabase's default kPasswordMinLength
            showMessage('Password must be at least 6 characters long.', true);
            return;
        }

        // --- UI update for loading state ---
        savePasswordBtn.style.display = 'none';
        loadingIndicator.style.display = 'block';

        try {
            // The `updateUser` method automatically uses the access_token
            // from the session established by onAuthStateChange.
            const { data, error } = await supabaseClient.auth.updateUser({
                password: newPassword
            });

            if (error) {
                throw error;
            }

            showMessage('Password updated successfully! You can now return to the Kindred app.', false);
            // Optionally, you can disable inputs after success
            newPasswordInput.disabled = true;
            confirmPasswordInput.disabled = true;


        } catch (error) {
            console.error('Error updating password:', error);
            // Provide a user-friendly error message
            const friendlyMessage = error.message.includes('same as the old')
                ? 'Your new password cannot be the same as your old one.'
                : `Error: ${error.message}`;
            showMessage(friendlyMessage, true);
        } finally {
            // --- Reset UI state ---
            // We keep the loader and hide the button on success to prevent re-submission
            if (messageDisplay.classList.contains('error')) {
                savePasswordBtn.style.display = 'block';
                loadingIndicator.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }
    }

    // Attach event listener to the button
    savePasswordBtn.addEventListener('click', handleResetPassword);

    // Check if a token was ever found after a short delay
    document.addEventListener('DOMContentLoaded', () => {
        savePasswordBtn.disabled = true; // Disable by default
        setTimeout(() => {
            if (!hasPasswordRecoveryToken) {
                showMessage('This page is for resetting your password. Please request a new link from the app if yours has expired.', true);
            }
        }, 1000); // Wait 1 second for Supabase to process the token
    });

</script>
</body>
</html>
